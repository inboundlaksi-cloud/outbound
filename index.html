<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกสถิติความผิดพลาดในการจัดสินค้า</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDK (Compat version as in original) -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-analytics-compat.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* CSS ทั้งหมด */
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #ffffff; /* White Background */
        }

        .container-wrapper {
            background-color: white;
            padding: 1.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
        }

        /* --- Sidebar & Layout --- */
        #main-app {
            display: flex;
            height: 100vh;
            background-color: #ffffff; /* White Background */
        }
        
        #sidebar {
            width: 260px;
            background-color: #ffffff;
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #e5e7eb;
        }
        
        main {
            flex: 1;
            overflow-y: auto;
        }
        
        #nav-toggle {
            display: none;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            color: #4b5563;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .nav-link:hover {
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .nav-link.active {
            background-color: #4f46e5;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2), 0 2px 4px -1px rgba(79, 70, 229, 0.12);
        }
        .nav-link i {
            width: 20px;
            margin-right: 0.75rem;
            text-align: center;
        }

        @media (max-width: 768px) {
            #sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                transform: translateX(-100%);
                z-index: 1000;
            }
            #sidebar.open {
                transform: translateX(0);
            }
            #nav-toggle {
                display: block;
                position: fixed;
                top: 1rem;
                left: 1rem;
                z-index: 1001;
            }
            #sidebar-overlay {
                position: fixed;
                inset: 0;
                background-color: rgba(0,0,0,0.5);
                z-index: 999;
            }
            main {
                 padding-top: 4rem; /* Space for the hamburger menu */
            }
            #page-title {
                font-size: 1.75rem; /* Smaller title on mobile */
            }
            .table-container th, .table-container td {
                padding: 0.5rem;
                font-size: 0.875rem;
            }
        }
        
        .table-container {
            border-radius: 1rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        /* Muted Table Headers */
        .table-header {
            background-color: #f9fafb;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.75rem;
        }

        th, td {
            white-space: nowrap;
            padding: 0.75rem;
            vertical-align: middle; 
        }
        
        .add-error-btn, .minus-error-btn {
            transition: all 0.1s ease-out;
        }

        .add-error-btn:active, .minus-error-btn:active {
            transform: scale(1.15);
        }
        
        .error-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            position: relative;
        }

        .modifier-tooltip {
            visibility: hidden; background-color: #333; color: #fff; text-align: center;
            border-radius: 6px; padding: 5px 8px; position: absolute; z-index: 1;
            bottom: 125%; left: 50%; transform: translateX(-50%);
            white-space: nowrap; opacity: 0; transition: opacity 0.3s;
        }
        
        .error-cell:hover .modifier-tooltip {
            visibility: visible; opacity: 1;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1); border-radius: 50%;
            border-top: 4px solid #3498db; width: 20px; height: 20px;
            animation: spin 1s linear infinite; display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .approval-badge {
            padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem;
            font-weight: 600; display: inline-block;
        }
        .approval-pending { background-color: #FEF3C7; color: #92400E; }
        .approval-approved { background-color: #D1FAE5; color: #065F46; }
        .approval-rejected { background-color: #FEE2E2; color: #991B1B; }

        .chart-container { position: relative; height: 400px; width: 100%; }
        
        /* Calendar Styles */
        #calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.25rem; }
        .calendar-day { background-color: #fff; border: 1px solid #e5e7eb; aspect-ratio: 1/1; display: flex; flex-direction: column; justify-content: space-between; padding: 0.5rem; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s ease; }
        .calendar-day:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .calendar-day.other-month { background-color: #f9fafb; color: #9ca3af; }
        .calendar-day.today { border-color: #4f46e5; border-width: 2px; }
        .calendar-day-header { font-weight: 600; }
        .calendar-day-body { text-align: right; font-size: 1.25rem; font-weight: 700; color: #ef4444; }
        
        /* Tab Navigation */
        .tab-button.active { color: #4f46e5; border-bottom-color: #4f46e5; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .prose { max-width: 100%; }
        .prose h2, .prose h3, .prose h4 { margin-top: 1.5em; margin-bottom: 0.5em; font-weight: 600; }
        .prose ul { list-style-position: inside; }
        .prose li { margin-bottom: 0.25em; }
    </style>
</head>
<body class="p-0 m-0">
    <!-- Login Section -->
    <div id="login-section" class="min-h-screen flex items-center justify-center bg-gray-50 p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
            <div class="text-center mb-8">
                <div class="mx-auto bg-indigo-100 w-16 h-16 rounded-full flex items-center justify-center mb-4">
                    <i class="fas fa-warehouse text-indigo-600 text-2xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-800">ระบบบันทึกสถิติ</h1>
                <p class="text-gray-600 mt-2">สำหรับพนักงาน Picking และหัวหน้างาน</p>
            </div>
            
            <div id="login-loading" class="hidden text-center"><div class="spinner mx-auto mb-4"></div><p>กำลังเข้าสู่ระบบ...</p></div>
            
            <div id="login-form">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2" for="email">อีเมล</label>
                    <input type="email" id="email" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="your@email.com">
                </div>
                <div id="login-error" class="hidden mb-4 p-3 bg-red-100 text-red-700 rounded-lg"></div>
                <button id="login-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition-colors">เข้าสู่ระบบ</button>
                <div class="mt-4 text-center"><p class="text-sm text-gray-600">ยังไม่มีบัญชี? <a href="#" id="show-register" class="text-indigo-600 hover:underline">สมัครสมาชิก</a></p></div>
            </div>
            
            <div id="register-form" class="hidden">
                <div class="mb-4"><label class="block text-sm font-medium mb-2" for="reg-name">ชื่อ-นามสกุล</label><input type="text" id="reg-name" class="w-full px-4 py-3 border rounded-lg" placeholder="ชื่อ-นามสกุล"></div>
                <div class="mb-4"><label class="block text-sm font-medium mb-2" for="reg-nickname">ชื่อเล่น</label><input type="text" id="reg-nickname" class="w-full px-4 py-3 border rounded-lg" placeholder="ชื่อเล่น"></div>
                <div class="mb-4"><label class="block text-sm font-medium mb-2" for="reg-email">อีเมล</label><input type="email" id="reg-email" class="w-full px-4 py-3 border rounded-lg" placeholder="your@email.com"></div>
                <div class="mb-4"><label class="block text-sm font-medium mb-2" for="reg-role">บทบาท</label><select id="reg-role" class="w-full px-4 py-3 border rounded-lg"><option value="PICKING">พนักงาน Picking</option><option value="CHECKER">พนักงาน Checker</option><option value="SENIOR">พนักงาน Senior</option></select></div>
                <div class="mb-6"><label class="flex items-center"><input type="checkbox" id="reg-terms" class="form-checkbox h-4 w-4"><span class="ml-2 text-sm">ฉันยอมรับ <a href="#" id="show-terms-link" class="text-indigo-600 hover:underline">เงื่อนไขและข้อกำหนด</a></span></label></div>
                <button id="register-btn" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700">สมัครสมาชิก</button>
                <div class="mt-4 text-center"><p class="text-sm">มีบัญชีอยู่แล้ว? <a href="#" id="show-login" class="text-indigo-600 hover:underline">เข้าสู่ระบบ</a></p></div>
            </div>
            
            <div id="pending-approval" class="hidden text-center py-8">
                <div class="mx-auto bg-yellow-100 w-16 h-16 rounded-full flex items-center justify-center mb-4"><i class="fas fa-clock text-yellow-600 text-2xl"></i></div>
                <h3 class="text-xl font-bold mb-2">รอการอนุมัติ</h3>
                <p>บัญชีของคุณอยู่ระหว่างการตรวจสอบ</p>
                <button id="logout-btn" class="mt-6 text-indigo-600 hover:underline">ออกจากระบบ</button>
            </div>
        </div>
    </div>
    
    <!-- Main Application -->
    <div id="main-app" class="hidden">
        <div id="sidebar-overlay" class="hidden md:hidden"></div>
        <!-- Sidebar Navigation -->
        <aside id="sidebar" class="w-64 bg-white shadow-md flex-shrink-0 flex flex-col">
            <div class="p-4 border-b text-center">
                <div class="mx-auto bg-indigo-100 w-12 h-12 rounded-full flex items-center justify-center mb-2">
                    <i class="fas fa-warehouse text-indigo-600 text-xl"></i>
                </div>
                <h2 class="text-lg font-bold text-gray-800">ระบบบันทึกสถิติ</h2>
            </div>
            <div id="user-profile-summary" class="p-4 border-b">
                <p id="user-id-display" class="text-sm font-medium text-gray-800 truncate"></p>
                <p id="user-role-display" class="text-xs text-indigo-600 font-semibold"></p>
            </div>
            <nav id="main-nav" class="flex-grow p-4 space-y-1"></nav>
            <div class="p-4 border-t space-y-2">
                <button id="logout-main-btn" class="w-full flex items-center justify-center gap-2 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                    <i class="fas fa-sign-out-alt"></i>ออกจากระบบ
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto">
            <button id="nav-toggle" class="md:hidden fixed top-4 left-4 z-50 bg-white p-2 rounded-md shadow-md">
                <i class="fas fa-bars text-gray-800"></i>
            </button>
            <div class="p-4 md:p-8">
                <header class="mb-8">
                    <h1 id="page-title" class="text-3xl md:text-4xl font-extrabold text-gray-900 mb-1"></h1>
                    <p id="page-subtitle" class="text-md text-gray-600 font-medium"></p>
                </header>
                
                <section id="dashboard-view" class="main-section">
                    <div id="latest-announcement-banner" class="mb-8"></div>
                    <div id="system-stats" class="mb-8 grid grid-cols-2 md:grid-cols-4 gap-4"></div>
                    <div id="dashboard-summary" class="mb-8 grid grid-cols-2 md:grid-cols-4 gap-4"></div>
                    <div id="interactive-dashboard" class="mb-8 bg-white rounded-xl p-6 shadow-lg">
                        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                            <div class="lg:col-span-2 bg-gray-50 p-4 rounded-lg"><h3 class="font-bold mb-3">การกระจายความผิดพลาด</h3><div class="chart-container h-64"><canvas id="errorDistributionChart"></canvas></div></div>
                            <div class="lg:col-span-3 bg-gray-50 p-4 rounded-lg"><h3 class="font-bold mb-3">5 อันดับพนักงานที่ผิดพลาดสูงสุด</h3><div id="top-error-employees" class="space-y-2"></div></div>
                        </div>
                    </div>
                    <div id="error-trends" class="mb-8 bg-white rounded-xl p-6 shadow-lg"><h2 class="text-xl font-bold mb-4">แนวโน้มความผิดพลาด 7 วันล่าสุด</h2><div class="chart-container"><canvas id="errorTrendsChart"></canvas></div></div>
                </section>

                <section id="daily-view" class="main-section hidden">
                    <div class="tab-container mb-6"><div class="tab-button active" data-tab="card-view"><i class="fas fa-id-card mr-2"></i> การ์ดพนักงาน</div><div class="tab-button" data-tab="table-view"><i class="fas fa-table mr-2"></i> ตารางข้อมูล</div><div class="tab-button" data-tab="log-view"><i class="fas fa-history mr-2"></i> ประวัติการแก้ไข</div></div>
                    <div id="card-view" class="tab-content active"><input type="text" id="employee-search-cards" placeholder="ค้นหาชื่อพนักงาน..." class="w-full p-3 mb-4 border rounded-lg"><div id="employee-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div></div>
                    <div id="table-view" class="tab-content"><input type="text" id="employee-search-table" placeholder="ค้นหาชื่อพนักงาน..." class="w-full p-3 mb-4 border rounded-lg"><div class="table-container shadow-lg"><table class="min-w-full"><thead class="table-header"><tr><th class="p-3">ชื่อพนักงาน</th><th>จัดสินค้าผิด</th><th>จัดสินค้าเกิน</th><th>จัดสินค้าขาด</th><th>Batch ไม่ตรง</th><th>จัดไม่ตรง Route</th><th>ความสะอาด</th><th>จัดถูก (ครั้ง)</th><th>รวมผิด</th></tr></thead><tbody id="employee-table-body"></tbody></table></div></div>
                    <div id="log-view" class="tab-content"><div class="bg-white p-6 rounded-xl shadow-lg"><div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4"><h3 class="text-xl font-bold mb-4 md:mb-0">บันทึกการแก้ไขล่าสุด</h3><div class="flex flex-col md:flex-row gap-3 w-full md:w-auto"><div class="relative"><input type="text" id="log-search" placeholder="ค้นหาใน log..." class="w-full md:w-64 p-2 pl-10 border rounded-lg"><i class="fas fa-search absolute left-3 top-3 text-gray-400"></i></div><select id="log-filter" class="p-2 border rounded-lg"><option value="all">ทุกประเภท</option><option value="เพิ่ม">เพิ่มข้อมูล</option><option value="ลด">ลดข้อมูล</option><option value="อนุมัติ">อนุมัติผู้ใช้</option><option value="ปฏิเสธ">ปฏิเสธผู้ใช้</option><option value="เปลี่ยนบทบาท">เปลี่ยนบทบาท</option><option value="รีเซ็ต">รีเซ็ตข้อมูล</option></select></div></div><ul id="log-list" class="space-y-2 max-h-96 overflow-y-auto"></ul></div></div>
                </section>

                <section id="kpi-view" class="main-section hidden">
                     <div class="mb-8 flex flex-col md:flex-row items-start md:items-center gap-4 bg-white p-4 rounded-lg shadow">
                         <label for="monthly-bills" class="text-lg font-medium whitespace-nowrap">จำนวนบิลประจำเดือน:</label>
                         <input type="number" id="monthly-bills" min="0" value="0" class="flex-grow p-3 text-lg border rounded-lg">
                         <button id="reset-button" class="bg-pink-500 text-white font-bold text-lg py-3 px-6 rounded-lg shadow hover:bg-pink-600"><i class="fas fa-sync-alt mr-2"></i>รีเซ็ตข้อมูล</button>
                         <button id="export-button" class="bg-purple-500 text-white font-bold text-lg py-3 px-6 rounded-lg shadow hover:bg-purple-600"><i class="fas fa-file-export mr-2"></i>ส่งออก</button>
                     </div>
                    <div class="table-container shadow-lg"><table class="min-w-full bg-white"><thead><tr class="table-header text-left"><th class="p-3">ชื่อพนักงาน</th><th class="text-center">รวมผิดพลาด</th><th class="text-center">อัตราผิดพลาด (%)</th><th class="text-center">อันดับ</th><th class="text-center">ผิดพลาดสูงสุด</th><th class="text-center">ดูรายละเอียด</th></tr></thead><tbody id="kpi-report-body" class="divide-y"></tbody></table></div>
                </section>
                
                <section id="calendar-view" class="main-section hidden">
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <div class="flex justify-between items-center mb-4">
                            <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-100"><i class="fas fa-chevron-left"></i></button>
                            <h2 id="calendar-month-year" class="text-xl font-bold"></h2>
                            <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-100"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div class="grid grid-cols-7 gap-2 text-center font-semibold text-sm text-gray-600 mb-2">
                            <div>อา.</div><div>จ.</div><div>อ.</div><div>พ.</div><div>พฤ.</div><div>ศ.</div><div>ส.</div>
                        </div>
                        <div id="calendar-grid"></div>
                    </div>
                </section>

                <section id="announcements-view" class="main-section hidden">
                    <div class="flex justify-end mb-4">
                        <button id="create-announcement-btn" class="hidden bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition-colors"><i class="fas fa-plus mr-2"></i>สร้างประกาศใหม่</button>
                    </div>
                    <div id="announcements-list" class="space-y-4">
                        <!-- Announcements will be loaded here -->
                    </div>
                </section>
                
                <section id="notifications-view" class="main-section hidden">
                    <div class="flex justify-end mb-4">
                        <button id="mark-all-read-btn" class="bg-indigo-100 text-indigo-700 text-sm font-bold py-2 px-4 rounded-lg hover:bg-indigo-200 transition-colors"><i class="fas fa-check-double mr-2"></i>ทำเครื่องหมายว่าอ่านทั้งหมด</button>
                    </div>
                    <div id="notifications-list" class="space-y-3">
                        <!-- Notifications will be loaded here -->
                    </div>
                </section>

                <section id="ai-view" class="main-section hidden">
                    <div id="ai-insights-container" class="bg-white p-6 rounded-xl shadow-lg">
                         <div class="flex items-center mb-4">
                            <i class="fas fa-robot text-3xl text-indigo-500 mr-4"></i>
                            <h2 class="text-2xl font-bold">วิเคราะห์และสรุปผลโดย AI</h2>
                        </div>
                        <div id="ai-content">
                            <div class="text-center p-8"><div class="spinner mx-auto mb-4"></div><p>กำลังวิเคราะห์ข้อมูล...</p></div>
                        </div>
                    </div>
                </section>

                <section id="detail-view" class="main-section hidden">
                     <h2 id="detail-employee-name" class="text-2xl md:text-3xl font-bold mb-6"></h2>
                     <div class="detail-view-container grid grid-cols-1 lg:grid-cols-2 gap-6">
                         <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-xl font-bold mb-4">สรุปสถิติ</h3><div class="space-y-2"><p><span class="font-semibold">ความผิดพลาดทั้งหมด:</span> <span id="summary-total-errors" class="font-bold text-red-500"></span></p><p><span class="font-semibold">จัดถูกต้อง:</span> <span id="summary-correct-picks" class="font-bold text-green-500"></span></p><p><span class="font-semibold">อัตราความผิดพลาด:</span> <span id="summary-pps" class="font-bold text-purple-600"></span></p><p><span class="font-semibold">ประเภทผิดพลาดสูงสุด:</span> <span id="summary-most-frequent" class="font-bold text-purple-600"></span></p></div></div>
                         <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-xl font-bold mb-4">สัดส่วนความผิดพลาด</h3><div class="chart-container h-64"><canvas id="errorBreakdownChart"></canvas></div></div>
                         <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg"><h3 class="text-xl font-bold mb-4">ประวัติการแก้ไขส่วนตัว</h3><ul id="employee-history-log" class="space-y-2 max-h-60 overflow-y-auto"></ul></div>
                     </div>
                </section>

                <section id="approval-view" class="main-section hidden">
                    <div class="table-container shadow-lg"><table class="min-w-full bg-white"><thead><tr class="table-header text-left"><th class="p-3">ชื่อผู้ใช้</th><th>อีเมล</th><th>บทบาท</th><th>สถานะ</th><th>วันที่สมัคร</th><th class="text-center">ดำเนินการ</th></tr></thead><tbody id="approval-table-body" class="divide-y"></tbody></table></div>
                </section>

                <section id="management-view" class="main-section hidden">
                    <div class="mb-6"><input type="text" id="employee-management-search" placeholder="ค้นหาชื่อหรืออีเมล..." class="w-full md:w-1/3 p-3 text-lg border rounded-lg"></div>
                    <div class="table-container shadow-lg"><table class="min-w-full bg-white"><thead><tr class="table-header text-left"><th class="p-3">ชื่อพนักงาน</th><th>อีเมล</th><th class="text-center">ตำแหน่ง</th><th class="text-center">สถานะ</th><th class="text-center">ความผิดพลาดรวม</th><th class="text-center">จัดการ</th></tr></thead><tbody id="employee-management-body" class="divide-y"></tbody></table></div>
                </section>
                
                <section id="profile-view" class="main-section hidden">
                    <div class="bg-white rounded-xl p-6 shadow-lg max-w-4xl mx-auto">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <div class="flex items-center mb-4">
                                    <div class="bg-indigo-100 w-20 h-20 rounded-full flex items-center justify-center mr-4"><i class="fas fa-user text-indigo-600 text-3xl"></i></div>
                                    <div>
                                        <h3 id="profile-name" class="text-2xl font-bold"></h3>
                                        <p id="profile-email" class="text-sm text-gray-600"></p>
                                        <p id="profile-role" class="font-medium text-indigo-600"></p>
                                    </div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <h4 class="text-lg font-bold mb-3">แก้ไขชื่อ</h4>
                                    <div class="flex"><input type="text" id="profile-name-input" class="flex-grow px-4 py-2 border rounded-l-lg"><button id="save-profile-name-btn" class="bg-blue-600 text-white px-4 py-2 rounded-r-lg hover:bg-blue-700">บันทึก</button></div>
                                </div>
                            </div>
                            <div>
                                 <h4 class="text-lg font-bold mb-3">สถิติข้อผิดพลาดส่วนตัว</h4>
                                 <div class="chart-container h-48"><canvas id="profileErrorChart"></canvas></div>
                            </div>
                        </div>
                         <div class="mt-8">
                             <h4 class="text-lg font-bold mb-3">ประวัติการกระทำของคุณ</h4>
                             <ul id="profile-log-list" class="space-y-2 max-h-60 overflow-y-auto"></ul>
                        </div>
                    </div>
                </section>
                
                 <section id="settings-view" class="main-section hidden">
                    <div class="bg-white p-6 rounded-xl shadow-lg max-w-2xl mx-auto">
                        <h2 class="text-2xl font-bold mb-4">ตั้งค่าระบบ</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="gemini-api-key" class="block text-sm font-medium text-gray-700">Gemini API Key</label>
                                <input type="password" id="gemini-api-key" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <p class="mt-2 text-xs text-gray-500">API Key ของคุณจะถูกบันทึกไว้ในเบราว์เซอร์นี้เท่านั้น</p>
                            </div>
                            <button id="save-settings-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition-colors">บันทึก</button>
                        </div>
                    </div>
                </section>

            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="employee-edit-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-md w-full">
            <h3 class="text-xl font-bold mb-4">แก้ไขข้อมูลพนักงาน</h3>
            <div class="mb-4"><label class="block text-sm font-medium mb-2">ชื่อพนักงาน</label><input type="text" id="edit-employee-name" class="w-full px-4 py-3 border rounded-lg bg-gray-100" readonly></div>
            <div class="mb-6"><label class="block text-sm font-medium mb-2">ตำแหน่ง</label><select id="edit-employee-role" class="w-full px-4 py-3 border rounded-lg"><option value="PICKING">PICKING</option><option value="CHECKER">CHECKER</option><option value="SENIOR">SENIOR</option><option value="SUPERVISOR">SUPERVISOR</option><option value="ADMIN">ADMIN</option></select></div>
            <div class="flex justify-end space-x-3"><button id="cancel-edit-btn" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">ยกเลิก</button><button id="save-edit-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">บันทึก</button></div>
        </div>
    </div>
    <div id="announcement-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-lg w-full">
            <h3 class="text-xl font-bold mb-4">สร้างประกาศใหม่</h3>
            <div class="mb-4"><label class="block text-sm font-medium mb-2">หัวข้อ</label><input type="text" id="announcement-title" class="w-full px-4 py-2 border rounded-lg"></div>
            <div class="mb-6"><label class="block text-sm font-medium mb-2">เนื้อหา</label><textarea id="announcement-content" rows="5" class="w-full px-4 py-2 border rounded-lg"></textarea></div>
            <div class="flex justify-end space-x-3"><button id="cancel-announcement-btn" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">ยกเลิก</button><button id="post-announcement-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">ประกาศ</button></div>
        </div>
    </div>
     <div id="calendar-detail-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-2xl w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 id="calendar-modal-title" class="text-xl font-bold"></h3>
                <button id="close-calendar-modal-btn" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <ul id="calendar-modal-log-list" class="space-y-2 max-h-96 overflow-y-auto"></ul>
        </div>
    </div>
     <div id="terms-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-2xl w-full">
            <h3 class="text-xl font-bold mb-4">ข้อตกลงและเงื่อนไขการใช้งาน</h3>
            <div class="prose max-w-none text-sm max-h-96 overflow-y-auto">
                <h4>1. การยอมรับข้อตกลง</h4>
                <p>โดยการสมัครและเข้าใช้งานระบบบันทึกสถิติความผิดพลาดนี้ ท่านยอมรับและตกลงที่จะปฏิบัติตามข้อตกลงและเงื่อนไขการใช้งานทั้งหมดที่ระบุไว้ ณ ที่นี้ หากท่านไม่ยอมรับข้อตกลงเหล่านี้ กรุณาอย่าเข้าใช้งานระบบ</p>
                <h4>2. วัตถุประสงค์ของระบบ</h4>
                <p>ระบบนี้ถูกสร้างขึ้นเพื่อวัตถุประสงค์ในการบันทึก ติดตาม และวิเคราะห์ข้อมูลความผิดพลาดในการจัดสินค้าของพนักงาน เพื่อนำไปสู่การปรับปรุงประสิทธิภาพและลดข้อผิดพลาดในการดำเนินงาน</p>
                <h4>3. การใช้งานบัญชี</h4>
                <p>ท่านมีหน้าที่รับผิดชอบในการรักษารายละเอียดบัญชีของท่านให้เป็นความลับ การกระทำใดๆ ที่เกิดขึ้นภายใต้บัญชีของท่านจะถือเป็นการกระทำของท่านเอง ท่านตกลงที่จะแจ้งให้ผู้ดูแลระบบทราบทันทีเมื่อมีการใช้งานบัญชีของท่านโดยไม่ได้รับอนุญาต</p>
                 <h4>4. ข้อมูลส่วนบุคคล</h4>
                <p>เราจะเก็บรวบรวมข้อมูลของท่าน เช่น ชื่อ, อีเมล, และข้อมูลสถิติการทำงาน เพื่อใช้ในการดำเนินงานของระบบเท่านั้น เราจะไม่เปิดเผยข้อมูลของท่านแก่บุคคลภายนอกโดยไม่ได้รับความยินยอมจากท่าน</p>
                 <h4>5. ข้อจำกัดความรับผิดชอบ</h4>
                <p>ข้อมูลที่แสดงผลในระบบมาจากข้อมูลที่ผู้ใช้งานได้บันทึกเข้ามา ผู้พัฒนาระบบไม่รับประกันความถูกต้องสมบูรณ์ของข้อมูล และไม่รับผิดชอบต่อความเสียหายใดๆ ที่อาจเกิดขึ้นจากการใช้ข้อมูลในระบบนี้</p>
            </div>
            <div class="flex justify-end mt-4">
                <button id="close-terms-modal-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">เข้าใจแล้ว</button>
            </div>
        </div>
    </div>
    <div id="toast-container" class="fixed bottom-4 right-4 z-[1002] flex flex-col space-y-2"></div>
    
    <script>
        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyCYSFu1MJWkEZjayF-e8-uiiX1caCc2PVI",
            authDomain: "outbound-f9dff.firebaseapp.com",
            projectId: "outbound-f9dff",
            storageBucket: "outbound-f9dff.appspot.com",
            messagingSenderId: "60363947536",
            appId: "1:60363947536:web:79c6581d5a8c2b9c1bd495",
            measurementId: "G-4SC1R235WY"
        };

        // --- Initialize Firebase ---
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = firebaseConfig.projectId;
        
        // --- Global State ---
        let employees = [];
        let monthlyBills = 0;
        let logs = [];
        let announcements = [];
        let currentUser = null;
        let chartInstances = {};
        let calendarDate = new Date();


        // --- Constants ---
        const errorTypes = [
            { key: "wrongItem", name: "จัดสินค้าผิด" }, { key: "overPicked", name: "จัดสินค้าเกิน" },
            { key: "underPicked", name: "จัดสินค้าขาด" }, { key: "wrongBatch", name: "Batch ไม่ตรง" },
            { key: "wrongRoute", name: "จัดไม่ตรง Route" }, { key: "cleanliness", name: "ความสะอาด" },
        ];
        const allRoles = ['PICKING', 'CHECKER', 'SENIOR', 'SUPERVISOR', 'ADMIN'];

        // --- DOM Elements ---
        const loginSection = document.getElementById('login-section');
        const mainApp = document.getElementById('main-app');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const pendingApproval = document.getElementById('pending-approval');
        const loginLoading = document.getElementById('login-loading');
        const loginError = document.getElementById('login-error');
        const mainNav = document.getElementById('main-nav');
        const pageTitle = document.getElementById('page-title');
        const pageSubtitle = document.getElementById('page-subtitle');
        const mainSections = document.querySelectorAll('.main-section');
        
        // --- Utility Functions ---
        const showToast = (message, type = 'info') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            let bgColor = 'bg-blue-500'; let icon = 'fa-info-circle';
            if (type === 'success') { bgColor = 'bg-green-500'; icon = 'fa-check-circle'; }
            if (type === 'error') { bgColor = 'bg-red-500'; icon = 'fa-exclamation-circle'; }
            toast.className = `${bgColor} text-white px-4 py-3 rounded-lg shadow-lg flex items-center transform transition-all duration-300 translate-x-full`;
            toast.innerHTML = `<i class="fas ${icon} mr-2"></i><span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.classList.remove('translate-x-full'), 10);
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => container.removeChild(toast), 300);
            }, 3000);
        };

        // --- Navigation ---
        const navItems = [
            { id: 'dashboard', text: 'ภาพรวมระบบ', icon: 'fa-chart-pie', roles: ['PICKING', 'CHECKER', 'SENIOR', 'SUPERVISOR', 'ADMIN'] },
            { id: 'announcements', text: 'ประกาศ', icon: 'fa-bullhorn', roles: ['PICKING', 'CHECKER', 'SENIOR', 'SUPERVISOR', 'ADMIN'] },
            { id: 'daily', text: 'ประเมินประจำวัน', icon: 'fa-calendar-day', roles: ['PICKING', 'CHECKER', 'SENIOR', 'SUPERVISOR', 'ADMIN'] },
            { id: 'kpi', text: 'รายงานสรุป KPI', icon: 'fa-chart-line', roles: ['SENIOR', 'SUPERVISOR', 'ADMIN'] },
            { id: 'calendar', text: 'ปฏิทิน', icon: 'fa-calendar-alt', roles: ['SENIOR', 'SUPERVISOR', 'ADMIN'] },
            { id: 'ai', text: 'วิเคราะห์โดย AI', icon: 'fa-robot', roles: ['SUPERVISOR', 'ADMIN'] },
            { id: 'approval', text: 'อนุมัติผู้ใช้งาน', icon: 'fa-user-check', roles: ['SUPERVISOR', 'ADMIN'] },
            { id: 'management', text: 'จัดการพนักงาน', icon: 'fa-users-cog', roles: ['SUPERVISOR', 'ADMIN'] },
            { id: 'profile', text: 'โปรไฟล์ของฉัน', icon: 'fa-user-circle', roles: ['PICKING', 'CHECKER', 'SENIOR', 'SUPERVISOR', 'ADMIN'] },
            { id: 'settings', text: 'ตั้งค่า', icon: 'fa-cog', roles: ['ADMIN'] }
        ];

        const renderNavigation = () => {
            mainNav.innerHTML = '';
            navItems.forEach(item => {
                if (item.roles.includes(currentUser.role)) {
                    const link = document.createElement('a');
                    link.href = '#';
                    link.className = 'nav-link';
                    link.dataset.view = item.id;
                    link.innerHTML = `<i class="fas ${item.icon}"></i> ${item.text}`;
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        toggleView(item.id);
                    });
                    mainNav.appendChild(link);
                }
            });
        };

        const toggleView = (viewId) => {
            mainSections.forEach(section => section.classList.add('hidden'));
            document.getElementById(`${viewId}-view`).classList.remove('hidden');

            mainNav.querySelectorAll('.nav-link').forEach(link => {
                link.classList.toggle('active', link.dataset.view === viewId);
            });
            
            const navItem = navItems.find(item => item.id === viewId);
            if(navItem) {
                pageTitle.textContent = navItem.text;
                pageSubtitle.textContent = `จัดการและดูข้อมูลเกี่ยวกับ ${navItem.text.toLowerCase()}`;
            }

            // Specific actions on view toggle
            switch(viewId) {
                case 'dashboard': renderDashboard(); break;
                case 'daily': renderDailyData(); break;
                case 'kpi': renderKpiReport(); break;
                case 'approval': renderApprovalTable(); break;
                case 'management': renderEmployeeManagementTable(); break;
                case 'profile': renderProfileView(); break;
                case 'calendar': renderCalendarView(); break;
                case 'ai': renderAiView(); break;
                case 'settings': renderSettingsView(); break;
                case 'announcements': renderAnnouncementsView(); break;
                case 'detail': /* Handled by button clicks */ break;
            }

            // Close sidebar on mobile after navigation
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebar-overlay').classList.add('hidden');
        };

        // --- Authentication ---
        const handleLogin = async () => {
            const email = document.getElementById('email').value.trim();
            if (!email) {
                loginError.textContent = 'กรุณากรอกอีเมล';
                loginError.classList.remove('hidden');
                return;
            }
            loginForm.classList.add('hidden');
            loginLoading.classList.remove('hidden');
            
            try {
                const usersRef = db.collection(`artifacts/${appId}/public/data/users`);
                const querySnapshot = await usersRef.where("email", "==", email).get();

                if (querySnapshot.empty) {
                    throw new Error('ไม่พบอีเมลนี้ในระบบ');
                }

                const userDoc = querySnapshot.docs[0];
                const userData = userDoc.data();

                if (userData.status === 'approved') {
                    const userToStore = { uid: userDoc.id, ...userData };
                    sessionStorage.setItem('loggedInUser', JSON.stringify(userToStore));
                    await auth.signInAnonymously(); // Ensure firebase auth session exists
                    initializeApp(userToStore);
                } else if (userData.status === 'pending') {
                    loginLoading.classList.add('hidden');
                    pendingApproval.classList.remove('hidden');
                } else {
                     throw new Error('บัญชีของคุณไม่ได้รับการอนุมัติ');
                }
            } catch(error) {
                loginLoading.classList.add('hidden');
                loginForm.classList.remove('hidden');
                loginError.textContent = error.message;
                loginError.classList.remove('hidden');
                showToast(error.message, 'error');
            }
        };
        
        const handleRegister = async () => {
            const name = document.getElementById('reg-name').value;
            const nickname = document.getElementById('reg-nickname').value;
            const email = document.getElementById('reg-email').value;
            const role = document.getElementById('reg-role').value;
            if (!name || !nickname || !email || !document.getElementById('reg-terms').checked) {
                return showToast('กรุณากรอกข้อมูลให้ครบถ้วนและยอมรับเงื่อนไข', 'error');
            }
            try {
                const usersRef = db.collection(`artifacts/${appId}/public/data/users`);
                const existingUser = await usersRef.where("email", "==", email).get();
                if (!existingUser.empty) return showToast('อีเมลนี้ถูกใช้งานแล้ว', 'error');
                
                await usersRef.add({
                    name: `${name} (${nickname})`, email, role, status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                loginForm.classList.add('hidden');
                registerForm.classList.add('hidden');
                pendingApproval.classList.remove('hidden');
                showToast('สมัครสมาชิกสำเร็จ รอการอนุมัติ', 'success');
            } catch (error) {
                showToast('เกิดข้อผิดพลาด: ' + error.message, 'error');
            }
        };

        const handleLogout = () => {
            auth.signOut().then(() => {
                sessionStorage.removeItem('loggedInUser');
                window.location.reload();
            });
        };

        // --- Data Fetching & Rendering ---
        const initializeData = async () => {
            showToast('กำลังโหลดข้อมูล...', 'info');
            try {
                // Fetch approved users to act as employees
                const usersSnapshot = await db.collection(`artifacts/${appId}/public/data/users`).where('status', '==', 'approved').get();
                const approvedUsers = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Fetch error tracking data
                const errorsSnapshot = await db.collection(`artifacts/${appId}/public/data/error_tracking`).get();
                const errorsMap = new Map();
                errorsSnapshot.forEach(doc => errorsMap.set(doc.id, doc.data().errors));

                // Merge user data with error data
                employees = approvedUsers.map(user => {
                    const userErrors = errorsMap.get(user.id) || {};
                    // Ensure all error types exist
                    const defaultErrors = { correctPicks: { value: 0, modifier: 'N/A' } };
                    errorTypes.forEach(type => defaultErrors[type.key] = { value: 0, modifier: 'N/A' });
                    
                    return { ...user, errors: { ...defaultErrors, ...userErrors } };
                });

                // Fetch monthly bills
                const billsDoc = await db.collection(`artifacts/${appId}/public/data/settings`).doc('monthlyBills').get();
                monthlyBills = billsDoc.exists ? billsDoc.data().value : 0;
                document.getElementById('monthly-bills').value = monthlyBills;

                // Fetch logs for calendar and log views
                const logsSnapshot = await db.collection(`artifacts/${appId}/public/data/logs`).orderBy('timestamp', 'desc').get();
                logs = logsSnapshot.docs.map(doc => doc.data());
                
                // Fetch announcements
                const announcementsSnapshot = await db.collection(`artifacts/${appId}/public/data/announcements`).orderBy('timestamp', 'desc').get();
                announcements = announcementsSnapshot.docs.map(doc => doc.data());


                showToast('ข้อมูลอัปเดตล่าสุดแล้ว', 'success');
            } catch (error) {
                console.error("Error initializing data:", error);
                showToast('ไม่สามารถโหลดข้อมูลได้', 'error');
            }
        };

        const renderDashboard = () => {
            renderLatestAnnouncementOnDashboard();
            renderSystemStats();
            renderDashboardSummary();
            renderErrorDistributionChart();
            renderTopErrorEmployees();
            renderErrorTrendsChart();
        };

        const renderDailyData = () => {
            renderDailyCards();
            renderDailyTable();
            renderLogList(document.getElementById('log-list'), logs); // render full log
        };

        const renderKpiReport = () => {
             renderMonthlyKpiTable();
        };
        
        async function saveLog(logEntry) {
            try {
                const logData = {
                    ...logEntry,
                    userName: currentUser.name,
                    userRole: currentUser.role,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                await db.collection(`artifacts/${appId}/public/data/logs`).add(logData);
                // Prepend to local logs array to avoid re-fetch
                logs.unshift({ ...logData, timestamp: new Date() });
            } catch (error) {
                console.error('Error saving log:', error);
            }
        }

        async function updateErrorValue(employeeId, errorType, change) {
            const empIndex = employees.findIndex(e => e.id === employeeId);
            if (empIndex === -1) return;

            const employee = employees[empIndex];
            
            if (!employee.errors[errorType]) {
                employee.errors[errorType] = { value: 0, modifier: 'N/A' };
            }

            const oldValue = employee.errors[errorType].value;
            const newValue = oldValue + change;

            if (newValue < 0) return;

            employee.errors[errorType].value = newValue;
            employee.errors[errorType].modifier = currentUser.role;

            try {
                const docRef = db.collection(`artifacts/${appId}/public/data/error_tracking`).doc(employeeId);
                await docRef.set({ errors: employee.errors, name: employee.name }, { merge: true });
                
                const logAction = change > 0 ? 'เพิ่ม' : 'ลด';
                const errorName = errorType === 'correctPicks' ? 'จัดถูก' : errorTypes.find(t => t.key === errorType)?.name || errorType;
                await saveLog({
                    modifierRole: currentUser.role,
                    employeeName: employee.name,
                    action: `${logAction} "${errorName}"`,
                    newValue: newValue
                });

                renderDailyCards();
                renderDailyTable();
                renderDashboard();
                showToast('อัปเดตข้อมูลแล้ว', 'success');
            } catch (error) {
                employee.errors[errorType].value = oldValue;
                console.error("Error saving data:", error);
                showToast('เกิดข้อผิดพลาดในการบันทึก', 'error');
            }
        }

        // --- Main App Initialization ---
        const initializeApp = (user) => {
            currentUser = user;
            loginSection.classList.add('hidden');
            mainApp.style.display = 'flex';
            
            document.getElementById('user-id-display').textContent = currentUser.name;
            document.getElementById('user-role-display').textContent = currentUser.role;
            
            renderNavigation();
            initializeData().then(() => {
                toggleView('dashboard');
            });
        };
        
        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            // Auth State
            auth.onAuthStateChanged(user => {
                const storedUserJSON = sessionStorage.getItem('loggedInUser');
                if (storedUserJSON) {
                    initializeApp(JSON.parse(storedUserJSON));
                } else {
                    if (!user) auth.signInAnonymously().catch(e => console.error(e));
                    loginSection.classList.remove('hidden');
                    mainApp.style.display = 'none';
                }
            });

            // Forms
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            document.getElementById('register-btn').addEventListener('click', handleRegister);
            document.getElementById('show-register').addEventListener('click', e => { e.preventDefault(); loginForm.classList.add('hidden'); registerForm.classList.remove('hidden'); });
            document.getElementById('show-login').addEventListener('click', e => { e.preventDefault(); registerForm.classList.add('hidden'); loginForm.classList.remove('hidden'); });
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('logout-main-btn').addEventListener('click', handleLogout);
            document.getElementById('show-terms-link').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('terms-modal').classList.remove('hidden') });
            document.getElementById('close-terms-modal-btn').addEventListener('click', () => document.getElementById('terms-modal').classList.add('hidden'));

            // Mobile Nav
            document.getElementById('nav-toggle').addEventListener('click', () => {
                document.getElementById('sidebar').classList.add('open');
                document.getElementById('sidebar-overlay').classList.remove('hidden');
            });
            document.getElementById('sidebar-overlay').addEventListener('click', () => {
                 document.getElementById('sidebar').classList.remove('open');
                document.getElementById('sidebar-overlay').classList.add('hidden');
            });

            // Tabs
             document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.dataset.tab;
                    const container = button.closest('.main-section');
                    container.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    container.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    button.classList.add('active');
                    container.querySelector(`#${tabId}`).classList.add('active');
                });
            });

             // Calendar navigation
            document.getElementById('prev-month-btn').addEventListener('click', () => {
                calendarDate.setMonth(calendarDate.getMonth() - 1);
                renderCalendarView();
            });
            document.getElementById('next-month-btn').addEventListener('click', () => {
                calendarDate.setMonth(calendarDate.getMonth() + 1);
                renderCalendarView();
            });
            document.getElementById('close-calendar-modal-btn').addEventListener('click', () => document.getElementById('calendar-detail-modal').classList.add('hidden'));

            // Settings
            document.getElementById('save-settings-btn').addEventListener('click', () => {
                const apiKey = document.getElementById('gemini-api-key').value;
                if (apiKey) {
                    localStorage.setItem('geminiApiKey', apiKey);
                    showToast('บันทึก API Key สำเร็จ', 'success');
                } else {
                    localStorage.removeItem('geminiApiKey');
                    showToast('ลบ API Key แล้ว', 'info');
                }
            });

            // Export Button
            document.getElementById('export-button').addEventListener('click', exportKpiReport);

            // Announcement Modal
            document.getElementById('create-announcement-btn').addEventListener('click', () => document.getElementById('announcement-modal').classList.remove('hidden'));
            document.getElementById('cancel-announcement-btn').addEventListener('click', () => document.getElementById('announcement-modal').classList.add('hidden'));
            document.getElementById('post-announcement-btn').addEventListener('click', postNewAnnouncement);
        });
        
        function renderDailyTable() {
            const tbody = document.getElementById('employee-table-body');
            tbody.innerHTML = '';
            
            const addEventListeners = () => {
                tbody.querySelectorAll('.add-error-btn, .minus-error-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.dataset.id;
                        const type = e.currentTarget.dataset.type;
                        const change = e.currentTarget.classList.contains('add-error-btn') ? 1 : -1;
                        updateErrorValue(id, type, change);
                    });
                });
            };

            if (employees.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" class="p-4 text-center text-gray-500">ไม่พบข้อมูลพนักงาน</td></tr>`;
                return;
            }

            employees.forEach(emp => {
                const row = document.createElement('tr');
                let totalErrors = 0;
                let errorCells = '';
                
                errorTypes.forEach(type => {
                    const count = emp.errors[type.key]?.value || 0;
                    if(type.key !== 'correctPicks') totalErrors += count;
                    errorCells += `<td class="p-2 border-b"><div class="error-cell"><button data-id="${emp.id}" data-type="${type.key}" class="minus-error-btn bg-red-100 text-red-600 rounded-full w-5 h-5 md:w-6 md:h-6 font-bold flex items-center justify-center hover:bg-red-200">-</button><span class="font-bold text-base md:text-lg w-6 md:w-8 text-center">${count}</span><button data-id="${emp.id}" data-type="${type.key}" class="add-error-btn bg-green-100 text-green-600 rounded-full w-5 h-5 md:w-6 md:h-6 font-bold flex items-center justify-center hover:bg-green-200">+</button></div></td>`;
                });
                
                const correctPicks = emp.errors.correctPicks?.value || 0;

                row.innerHTML = `
                    <td class="p-3 border-b font-medium">${emp.name}</td>
                    ${errorCells}
                    <td class="p-2 border-b text-center"><div class="error-cell"><button data-id="${emp.id}" data-type="correctPicks" class="minus-error-btn bg-red-100 text-red-600 rounded-full w-5 h-5 md:w-6 md:h-6 font-bold flex items-center justify-center hover:bg-red-200">-</button><span class="font-bold text-base md:text-lg w-6 md:w-8 text-center">${correctPicks}</span><button data-id="${emp.id}" data-type="correctPicks" class="add-error-btn bg-green-100 text-green-600 rounded-full w-5 h-5 md:w-6 md:h-6 font-bold flex items-center justify-center hover:bg-green-200">+</button></div></td>
                    <td class="p-3 border-b font-bold text-center text-red-500">${totalErrors}</td>
                `;
                tbody.appendChild(row);
            });
            addEventListeners();
        }

        function renderDailyCards() {
            const container = document.getElementById('employee-cards-container');
            container.innerHTML = '';

            const addEventListeners = () => {
                container.querySelectorAll('.add-error-btn, .minus-error-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.dataset.id;
                        const type = e.currentTarget.dataset.type;
                        const change = e.currentTarget.classList.contains('add-error-btn') ? 1 : -1;
                        updateErrorValue(id, type, change);
                    });
                });
            };
            
            if (employees.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-8 text-gray-500">ไม่พบข้อมูลพนักงาน</div>`;
                return;
            }

            employees.forEach(emp => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow p-4 flex flex-col space-y-3';
                let totalErrors = 0;
                let errorRows = '';

                errorTypes.forEach(type => {
                    const count = emp.errors[type.key]?.value || 0;
                    if(type.key !== 'correctPicks') totalErrors += count;
                    errorRows += `<div class="flex justify-between items-center"><span class="text-sm font-medium text-gray-700">${type.name}</span><div class="error-cell"><button data-id="${emp.id}" data-type="${type.key}" class="minus-error-btn bg-red-100 text-red-600 rounded-full w-5 h-5 md:w-6 md:h-6 font-bold flex items-center justify-center hover:bg-red-200">-</button><span class="font-bold text-base md:text-lg w-6 md:w-8 text-center">${count}</span><button data-id="${emp.id}" data-type="${type.key}" class="add-error-btn bg-green-100 text-green-600 rounded-full w-5 h-5 md:w-6 md:h-6 font-bold flex items-center justify-center hover:bg-green-200">+</button></div></div>`;
                });

                const correctPicks = emp.errors.correctPicks?.value || 0;
                const correctPicksRow = `<div class="flex justify-between items-center"><span class="text-sm font-medium text-green-600">จัดถูก</span><div class="error-cell"><button data-id="${emp.id}" data-type="correctPicks" class="minus-error-btn bg-red-100 text-red-600 rounded-full w-5 h-5 md:w-6 md:h-6 font-bold flex items-center justify-center hover:bg-red-200">-</button><span class="font-bold text-base md:text-lg w-6 md:w-8 text-center">${correctPicks}</span><button data-id="${emp.id}" data-type="correctPicks" class="add-error-btn bg-green-100 text-green-600 rounded-full w-5 h-5 md:w-6 md:h-6 font-bold flex items-center justify-center hover:bg-green-200">+</button></div></div>`;

                card.innerHTML = `
                    <div>
                        <div class="flex justify-between items-baseline">
                            <h3 class="font-bold text-gray-800">${emp.name}</h3>
                            <p class="text-sm">รวมผิด: <span class="font-bold text-red-500 text-lg">${totalErrors}</span></p>
                        </div>
                    </div>
                    <div class="space-y-2 border-t pt-3">${errorRows}${correctPicksRow}</div>
                `;
                container.appendChild(card);
            });
            addEventListeners();
        }

        function renderMonthlyKpiTable() { 
            const tbody = document.getElementById('kpi-report-body');
            tbody.innerHTML = '';
            
            if (!employees || employees.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-gray-500">ไม่พบข้อมูลพนักงาน</td></tr>`;
                return;
            }

            const employeeMetrics = employees.map(emp => {
                 const totalErrors = Object.keys(emp.errors).reduce((sum, key) => {
                    if (key !== 'correctPicks') {
                        return sum + (emp.errors[key]?.value || 0);
                    }
                    return sum;
                }, 0);
                
                const pps = (monthlyBills > 0) ? ((totalErrors * 100) / monthlyBills).toFixed(2) : '0.00';

                let mostFrequentError = { name: '-', count: 0 };
                if (totalErrors > 0) {
                     const topError = errorTypes.reduce((max, type) => {
                        const count = emp.errors[type.key]?.value || 0;
                        return count > max.count ? { name: type.name, count } : max;
                    }, { name: '-', count: 0 });
                    if(topError.count > 0) mostFrequentError = topError;
                }
                
                return { ...emp, totalErrors, pps: parseFloat(pps), mostFrequentError };
            }).sort((a, b) => b.totalErrors - a.totalErrors);

            employeeMetrics.forEach((emp, index) => {
                const row = document.createElement('tr');
                const rank = index + 1;
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="p-3 border-b font-medium">${emp.name}</td>
                    <td class="p-3 border-b text-center font-bold text-red-500">${emp.totalErrors}</td>
                    <td class="p-3 border-b text-center">${emp.pps}%</td>
                    <td class="p-3 border-b text-center font-bold">${rank}</td>
                    <td class="p-3 border-b text-center">${emp.mostFrequentError.name}</td>
                    <td class="p-3 border-b text-center">
                        <button class="view-details-btn bg-indigo-100 text-indigo-700 text-xs py-1 px-3 rounded-full hover:bg-indigo-200" data-id="${emp.id}">รายละเอียด</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
             tbody.querySelectorAll('.view-details-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const employeeId = e.currentTarget.dataset.id;
                    renderEmployeeDetail(employeeId);
                });
            });
        }
        
        async function renderApprovalTable() { 
            const tbody = document.getElementById('approval-table-body');
            tbody.innerHTML = `<tr><td colspan="6" class="p-4 text-center">กำลังโหลด...</td></tr>`;
            const usersSnapshot = await db.collection(`artifacts/${appId}/public/data/users`).where('status', '==', 'pending').get();
            tbody.innerHTML = '';
            if(usersSnapshot.empty) {
                tbody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-gray-500">ไม่มีผู้ใช้ที่รอการอนุมัติ</td></tr>`;
                return;
            }
            usersSnapshot.forEach(doc => {
                 const user = doc.data();
                 const row = document.createElement('tr');
                 row.innerHTML = `
                    <td class="p-3 border-b">${user.name}</td>
                    <td class="p-3 border-b">${user.email}</td>
                    <td class="p-3 border-b">${user.role}</td>
                    <td class="p-3 border-b"><span class="approval-badge approval-pending">รออนุมัติ</span></td>
                    <td class="p-3 border-b">${new Date(user.createdAt.toDate()).toLocaleDateString()}</td>
                    <td class="p-3 border-b text-center">
                        <button class="approve-btn bg-green-500 text-white text-xs py-1 px-2 rounded hover:bg-green-600" data-id="${doc.id}" data-name="${user.name}">อนุมัติ</button>
                        <button class="reject-btn bg-red-500 text-white text-xs py-1 px-2 rounded hover:bg-red-600" data-id="${doc.id}">ปฏิเสธ</button>
                    </td>
                 `;
                 tbody.appendChild(row);
            });
            tbody.querySelectorAll('.approve-btn').forEach(btn => btn.addEventListener('click', e => approveUser(e.target.dataset.id, e.target.dataset.name, true)));
            tbody.querySelectorAll('.reject-btn').forEach(btn => btn.addEventListener('click', e => approveUser(e.target.dataset.id, null, false)));
        }

        async function approveUser(userId, userName, isApproved) {
            const status = isApproved ? 'approved' : 'rejected';
            await db.collection(`artifacts/${appId}/public/data/users`).doc(userId).update({ status });

            if (isApproved) {
                const initialErrors = { correctPicks: { value: 0, modifier: 'SYSTEM' } };
                errorTypes.forEach(type => initialErrors[type.key] = { value: 0, modifier: 'SYSTEM' });
                await db.collection(`artifacts/${appId}/public/data/error_tracking`).doc(userId).set({ errors: initialErrors, name: userName });
            }
            showToast(`ผู้ใช้ได้รับการ ${isApproved ? 'อนุมัติ' : 'ปฏิเสธ'} แล้ว`, 'success');
            renderApprovalTable();
            initializeData(); // Refresh employee list
        }
        
        function renderDashboardSummary() { /* ... */ }
        function renderSystemStats() { /* ... */ }
        function renderErrorDistributionChart() { /* ... Chart.js logic ... */ }
        function renderTopErrorEmployees() { /* ... Logic to display top employees ... */ }
        function renderErrorTrendsChart() { /* ... Chart.js logic ... */ }
        
        function renderProfileView() {
            if (!currentUser) return;
            const employee = employees.find(emp => emp.id === currentUser.uid);
            
            document.getElementById('profile-name').textContent = currentUser.name;
            document.getElementById('profile-email').textContent = currentUser.email;
            document.getElementById('profile-role').textContent = currentUser.role;
            document.getElementById('profile-name-input').value = currentUser.name;

            const myLogs = logs.filter(log => log.userName === currentUser.name);
            renderLogList(document.getElementById('profile-log-list'), myLogs);
            
            if (employee && chartInstances.profileErrorChart) {
                chartInstances.profileErrorChart.destroy();
            }
            if (employee) {
                const ctx = document.getElementById('profileErrorChart').getContext('2d');
                const errorData = errorTypes.map(type => employee.errors[type.key]?.value || 0);
                const errorLabels = errorTypes.map(type => type.name);
                 chartInstances.profileErrorChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: errorLabels,
                        datasets: [{ data: errorData, backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'] }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }
        }
        
        function renderLogList(container, logsToRender) {
            container.innerHTML = '';
             if (!logsToRender || logsToRender.length === 0) {
                container.innerHTML = `<li class="text-center text-gray-500 p-4">ไม่มีข้อมูล</li>`;
                return;
            }
            logsToRender.forEach(log => {
                const li = document.createElement('li');
                li.className = 'p-3 bg-gray-50 rounded-lg';
                const logTime = log.timestamp?.toDate ? log.timestamp.toDate() : new Date();

                li.innerHTML = `
                    <div class="flex items-start">
                        <div class="flex-1">
                             <p class="font-bold text-gray-800">${log.userName || 'N/A'} <span class="font-normal text-gray-500">(${log.userRole || 'N/A'})</span></p>
                             <p class="mt-1 text-gray-700">
                                <span class="font-medium text-indigo-600">${log.action}</span> ให้กับ 
                                <span class="font-medium">${log.employeeName}</span> 
                                (ค่าใหม่: <span class="font-bold text-red-500">${log.newValue}</span>)
                            </p>
                             <p class="text-xs text-gray-500 mt-1">${logTime.toLocaleString('th-TH')}</p>
                        </div>
                    </div>
                `;
                container.appendChild(li);
            });
        }
        
        async function renderEmployeeManagementTable() {
            const tbody = document.getElementById('employee-management-body');
            tbody.innerHTML = `<tr><td colspan="6" class="p-4 text-center">กำลังโหลด...</td></tr>`;
            try {
                const usersSnapshot = await db.collection(`artifacts/${appId}/public/data/users`).get();
                const allUsers = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                tbody.innerHTML = '';
                if(allUsers.length === 0) {
                     tbody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-gray-500">ไม่พบข้อมูลผู้ใช้</td></tr>`;
                     return;
                }
                
                allUsers.forEach(user => {
                    const empData = employees.find(e => e.id === user.id);
                    const totalErrors = empData ? Object.keys(empData.errors).reduce((sum, key) => key !== 'correctPicks' ? sum + (empData.errors[key]?.value || 0) : sum, 0) : 'N/A';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="p-3 border-b">${user.name}</td>
                        <td class="p-3 border-b">${user.email}</td>
                        <td class="p-3 border-b text-center">${user.role}</td>
                        <td class="p-3 border-b text-center">${user.status}</td>
                        <td class="p-3 border-b text-center">${totalErrors}</td>
                        <td class="p-3 border-b text-center">
                             <button class="edit-employee-btn bg-blue-100 text-blue-700 text-xs py-1 px-3 rounded-full hover:bg-blue-200" data-id="${user.id}" data-name="${user.name}" data-role="${user.role}">แก้ไข</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

            } catch(e) {
                tbody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-500">เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>`;
            }
        }

        function renderCalendarView() {
            const calendarGrid = document.getElementById('calendar-grid');
            const monthYearEl = document.getElementById('calendar-month-year');
            calendarGrid.innerHTML = '';
            monthYearEl.textContent = calendarDate.toLocaleDateString('th-TH', { month: 'long', year: 'numeric' });

            const errorsByDate = logs.reduce((acc, log) => {
                if (log.action.includes('เพิ่ม') && log.action.includes('ความผิดพลาด')) {
                    const date = log.timestamp.toDate().toISOString().split('T')[0];
                    acc[date] = (acc[date] || 0) + 1;
                }
                return acc;
            }, {});

            const date = new Date(calendarDate);
            date.setDate(1);
            const firstDayIndex = date.getDay();
            date.setMonth(date.getMonth() + 1);
            date.setDate(0);
            const lastDay = date.getDate();

            for (let i = 0; i < firstDayIndex; i++) {
                calendarGrid.innerHTML += '<div></div>';
            }

            for (let i = 1; i <= lastDay; i++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                const today = new Date();
                if (i === today.getDate() && calendarDate.getMonth() === today.getMonth() && calendarDate.getFullYear() === today.getFullYear()) {
                    dayEl.classList.add('today');
                }
                
                const dateStr = `${calendarDate.getFullYear()}-${String(calendarDate.getMonth() + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const errorCount = errorsByDate[dateStr] || 0;

                dayEl.innerHTML = `
                    <div class="calendar-day-header">${i}</div>
                    <div class="calendar-day-body">${errorCount > 0 ? errorCount : ''}</div>
                `;
                dayEl.dataset.date = dateStr;
                dayEl.addEventListener('click', (e) => showCalendarDayDetails(e.currentTarget.dataset.date));
                calendarGrid.appendChild(dayEl);
            }
        }
        
        function showCalendarDayDetails(dateStr) {
            const modal = document.getElementById('calendar-detail-modal');
            const titleEl = document.getElementById('calendar-modal-title');
            const logListEl = document.getElementById('calendar-modal-log-list');

            const date = new Date(dateStr + 'T00:00:00'); // Ensure correct date parsing
            titleEl.textContent = `รายละเอียดวันที่ ${date.toLocaleDateString('th-TH', { day: 'numeric', month: 'long', year: 'numeric' })}`;

            const startOfDay = new Date(dateStr);
            startOfDay.setHours(0, 0, 0, 0);
            const endOfDay = new Date(dateStr);
            endOfDay.setHours(23, 59, 59, 999);
            
            const dayLogs = logs.filter(log => {
                const logDate = log.timestamp.toDate();
                return logDate >= startOfDay && logDate <= endOfDay;
            });
            
            renderLogList(logListEl, dayLogs);
            modal.classList.remove('hidden');
        }

        async function getAiAnalysisFromGemini(employeeData, apiKey) {
            const simplifiedData = employeeData.map(emp => {
                const errors = {};
                errorTypes.forEach(type => {
                    errors[type.name] = emp.errors[type.key]?.value || 0;
                });
                return { name: emp.name, errors: errors };
            });

            const prompt = `You are a professional warehouse operations analyst. Analyze the following JSON data which represents employee picking errors for a period. Provide a concise analysis and actionable recommendations in THAI language.

Your analysis should cover:
1.  **Overall Summary:** A brief overview of the performance.
2.  **Top Performer (by lowest errors):** Identify the employee with the fewest mistakes.
3.  **Employee Requiring Attention:** Identify the employee with the most mistakes and suggest specific areas for improvement.
4.  **Most Common Error:** Pinpoint the most frequent type of error across all employees.
5.  **Actionable Recommendations:** Provide 2-3 specific, practical suggestions for warehouse managers to reduce these errors.

Format your response using Markdown for clarity (headings, bold text, and bullet points).

Here is the data:
${JSON.stringify(simplifiedData, null, 2)}
`;
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API request failed: ${errorData.error.message}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates[0]?.content.parts[0]?.text) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    throw new Error('ไม่ได้รับข้อมูลการวิเคราะห์จาก AI');
                }
            } catch (error) {
                console.error('Error calling Gemini API:', error);
                throw error;
            }
        }

        async function renderAiView() {
            const container = document.getElementById('ai-content');
            const userProvidedApiKey = "AIzaSyB3PCMRQE_QobI_fnO11299hoWlKCurksE";
            const apiKey = localStorage.getItem('geminiApiKey') || userProvidedApiKey;
            
            if (!apiKey) {
                container.innerHTML = `<div class="text-center p-8 bg-yellow-50 rounded-lg"><i class="fas fa-key text-4xl text-yellow-500 mb-4"></i><h3 class="font-bold text-lg">ต้องการ API Key</h3><p class="text-gray-600 mt-2">กรุณาไปที่เมนู 'ตั้งค่า' เพื่อเพิ่ม Gemini API Key ของคุณ</p></div>`;
                return;
            }

            container.innerHTML = `<div class="text-center p-8"><div class="spinner mx-auto mb-4"></div><p>กำลังวิเคราะห์ข้อมูลด้วย Gemini...</p></div>`;
            
            try {
                const analysisText = await getAiAnalysisFromGemini(employees, apiKey);
                let htmlContent = analysisText
                    .replace(/### (.*)/g, '<h4 class="text-lg font-semibold mt-3 mb-1">$1</h4>')
                    .replace(/## (.*)/g, '<h3 class="text-xl font-bold mt-4 mb-2">$1</h2>')
                    .replace(/\*\*([^*]+)\*\*/g, '<b>$1</b>')
                    .replace(/\* ([^*]+)/g, '<li class="ml-5 list-disc">$1</li>')
                    .replace(/\n/g, '<br>');

                container.innerHTML = `<div class="prose max-w-none">${htmlContent}</div>`;
            } catch (error) {
                container.innerHTML = `<div class="text-center p-8 bg-red-50 rounded-lg"><i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i><h3 class="font-bold text-lg">เกิดข้อผิดพลาด</h3><p class="text-gray-600 mt-2">ไม่สามารถวิเคราะห์ข้อมูลได้: ${error.message}</p><p class="text-xs text-gray-500 mt-2">โปรดตรวจสอบ API Key ในหน้าตั้งค่า หรือลองอีกครั้งในภายหลัง</p></div>`;
            }
        }
        
        function renderSettingsView() {
            const apiKey = localStorage.getItem('geminiApiKey') || '';
            document.getElementById('gemini-api-key').value = apiKey;
        }

        function renderEmployeeDetail(employeeId) {
             const employee = employees.find(emp => emp.id === employeeId);
             if (!employee) return;

             document.getElementById('detail-employee-name').textContent = `รายละเอียด: ${employee.name}`;
             const totalErrors = Object.keys(employee.errors).reduce((sum, key) => key !== 'correctPicks' ? sum + (employee.errors[key]?.value || 0) : sum, 0);
             document.getElementById('summary-total-errors').textContent = totalErrors;
             document.getElementById('summary-correct-picks').textContent = employee.errors.correctPicks?.value || 0;
             // ... populate other fields and charts ...
             toggleView('detail');
        }

        function exportKpiReport() {
            const rows = [['อันดับ', 'ชื่อพนักงาน', 'รวมผิดพลาด', 'อัตราผิดพลาด (%)', 'ผิดพลาดสูงสุด']];
            const tableRows = document.querySelectorAll('#kpi-report-body tr');
            
            tableRows.forEach(row => {
                const cols = row.querySelectorAll('td');
                if (cols.length > 0) {
                    const rank = cols[3].innerText;
                    const name = `"${cols[0].innerText}"`; // Handle commas in names
                    const errors = cols[1].innerText;
                    const rate = cols[2].innerText.replace('%', '');
                    const topError = `"${cols[4].innerText}"`;
                    rows.push([rank, name, errors, rate, topError]);
                }
            });

            let csvContent = "\uFEFF" + rows.map(e => e.join(",")).join("\n"); // Add BOM for Excel compatibility

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `kpi_report_${new Date().toISOString().slice(0,10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            showToast('ส่งออกรายงานสำเร็จ', 'success');
        }

        function renderAnnouncementsView() {
            const container = document.getElementById('announcements-list');
            const createBtn = document.getElementById('create-announcement-btn');
            container.innerHTML = '';

            if (['SUPERVISOR', 'ADMIN'].includes(currentUser.role)) {
                createBtn.classList.remove('hidden');
            } else {
                createBtn.classList.add('hidden');
            }

            if(announcements.length === 0) {
                 container.innerHTML = `<div class="text-center p-8 text-gray-500">ยังไม่มีประกาศ</div>`;
                 return;
            }

            announcements.forEach(ann => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow';
                const postDate = ann.timestamp?.toDate ? ann.timestamp.toDate() : new Date();
                card.innerHTML = `
                    <h3 class="font-bold text-lg text-indigo-700">${ann.title}</h3>
                    <p class="text-xs text-gray-500 mb-2">ประกาศโดย: ${ann.authorName} (${ann.authorRole}) - ${postDate.toLocaleString('th-TH')}</p>
                    <p class="text-gray-700 whitespace-pre-wrap">${ann.content}</p>
                `;
                container.appendChild(card);
            });
        }
        
        async function postNewAnnouncement() {
            const title = document.getElementById('announcement-title').value;
            const content = document.getElementById('announcement-content').value;

            if(!title || !content) {
                showToast('กรุณากรอกข้อมูลให้ครบถ้วน', 'error');
                return;
            }

            const newAnnouncement = {
                title,
                content,
                authorName: currentUser.name,
                authorRole: currentUser.role,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection(`artifacts/${appId}/public/data/announcements`).add(newAnnouncement);
                announcements.unshift({ ...newAnnouncement, timestamp: new Date() });
                renderAnnouncementsView();
                document.getElementById('announcement-modal').classList.add('hidden');
                document.getElementById('announcement-title').value = '';
                document.getElementById('announcement-content').value = '';
                showToast('ประกาศสำเร็จ', 'success');
            } catch(e) {
                showToast('เกิดข้อผิดพลาดในการประกาศ', 'error');
                console.error(e);
            }
        }
        
        function renderLatestAnnouncementOnDashboard() {
            const container = document.getElementById('latest-announcement-banner');
            container.innerHTML = '';
            if (announcements.length > 0) {
                const latest = announcements[0];
                container.innerHTML = `
                    <div class="bg-indigo-50 border-l-4 border-indigo-500 p-4 rounded-r-lg">
                        <div class="flex items-center">
                            <i class="fas fa-bullhorn text-indigo-500 mr-3"></i>
                            <div>
                                <p class="font-bold text-indigo-800">${latest.title}</p>
                                <p class="text-sm text-indigo-700">${latest.content.substring(0, 100)}...</p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

    </script>
</body>
</html>

